<html>
  <head>
    <title>Huffman coding demo</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script>
      var sortCounts = function(a, b){
        return b.count - a.count;
      };

      var sortCodes = function(a, b){
        return a.length - b.length;
      };

      var getNodeLengths = function(node, height){
        if(node.symbol){
          return [new function(){
           this.symbol = node.symbol;
           this.length = height;
          }];
        }
        else{
          var out = getNodeLengths(node.children[0], height+1).concat(getNodeLengths(node.children[1], height+1));
          return out;
        }
      }

      var getTreeLengths = function(tree){
        return tree.reduce(function (array, value){
          return array.concat(getNodeLengths(value, 1));
        }, []);
      }

      var buildHuffmanTree = function(counts){
        while(counts.length > 2){
          counts = counts.sort(sortCounts);
          var children = [];
          children.push(counts.pop());
          children.push(counts.pop());
          var totalCount = children[0].count + children[1].count;
          var newCount = new function(){
            this.children = children;
            this.count = totalCount;
            this.symbol = null;
          }
          counts.push(newCount);
        }
        return counts;
      };

      var updateCodes = function(){
        var counts = $("#letterCounts").val().split("\n").map(x => x.split(": "))
          .map(x => new function(){
            this.symbol = x[0];
            this.count = parseInt(x[1]);
          });

        if(counts.length < 2){
          $("#codes").val("");
          return;
        }

        var huffmanTree = buildHuffmanTree(counts);
        var codeLengths = getTreeLengths(huffmanTree);
        var codes = codeLengths.sort(sortCodes)
            //.map(x => x.symbol + ": " + x.length)
            .reduce(function(array, codeLength){
              if(array.length == 0){
                var newCode = "0".padStart(codeLength.length, "0");
              }
              else{
                code = array[array.length-1].code;
                bits = code.length;
                var codeAsNumber = parseInt(code, 2);
                var newBits = codeLength.length;
                var shift = newBits - bits;
                codeAsNumber = codeAsNumber << shift;
                codeAsNumber++;
                var newCode = codeAsNumber.toString(2).padStart(newBits, "0");
              }
              array.push(new function(){
                this.symbol = codeLength.symbol;
                this.code = newCode;
              });

              return array;
            }, []);
        $("#codes").val(
          codes.map(x => (x.symbol + ":").padEnd(7, " ") + x.code)
            .join("\n")
        );
      };

      var calculateCounts = function(numbers){
        var counts = []

        numbers.forEach(function(number){
          if(!counts[number]){
            counts[number] = 0;
          }

          counts[number]++;
        });

        return counts.map(function (count, index){
          return new function(){
            this.symbol = index;
            this.count = count;
          };
        }).filter(n => true);
      };

      var updateCounts = function(){
        var counts = calculateCounts($("#numbers").val().split(",")).sort(sortCounts);
        $("#counts").val(
          counts.map(x => x.symbol + ": " + x.count)
          .join("\n")
        );
        $("#letterCounts").val(
          counts.map(x => String.fromCharCode(x.symbol) + ": " + x.count)
          .join("\n")
        );
        updateCodes();
      };

      var charToNumber = function(char){
        return char.charCodeAt(0);
      };

      var updateNumbers = function(){
        var plaintext = $("#plaintext").val();
        $("#numbers").val(
          plaintext.split("").map(x => charToNumber(x)).join(",")
        );
        updateCounts();
      };

      $(function() {
        $("#plaintext").on("input change keyup", updateNumbers);
        $("#numbers").on("input change keyup", updateCounts);
        $("#counts").on("input change keyup", updateCodes);
        updateNumbers();
      });
    </script>
  </head>
  <body>
    <div>
      Plaintext<br />
      <textarea id="plaintext" cols=50 rows=5>I went to an Ivy League school, I'm very highly educated. I know words, I had the best words. I have - but there's no better word than stupid.</textarea>
    </div>
    <div style="display: none;">
      Plaintext as numbers<br />
      <textarea id="numbers" cols=50, rows=10></textarea>
    </div>
    <div style="display: none;">
      Frequencies of each number<br />
      <textarea id="counts" cols=20, rows=20></textarea>
    </div>
    <div>
      Frequencies of each letter<br />
      <textarea id="letterCounts" cols=20, rows=20></textarea>
    </div>
    <div>
      Huffman codes<br />
      <textarea id="codes" cols=20, rows=20></textarea>
    </div>
  </body>
</html>